services:
  # FastAPI Backend
  - type: web
    name: transcription-pro-api
    runtime: python
    region: oregon
    plan: free
    buildCommand: pip install -r backend/requirements.txt
    startCommand: cd backend && uvicorn app.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: PYTHON_VERSION
        value: 3.12
      - key: DATABASE_URL
        fromDatabase:
          name: transcription-db
          property: connectionString
      - key: REDIS_URL
        fromDatabase:
          name: transcription-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromDatabase:
          name: transcription-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromDatabase:
          name: transcription-redis
          property: connectionString
      - key: DEBUG
        value: false
      - key: CORS_ORIGINS
        value: https://transcription-pro.vercel.app,http://localhost:3000
      - key: WHISPER_MODEL_SIZE
        value: large-v3
      - key: WHISPER_DEVICE
        value: cuda
      - key: WHISPER_COMPUTE_TYPE
        value: int8
      - key: ENABLE_VOCAL_SEPARATION
        value: false
      - key: MAX_FILE_SIZE_MB
        value: 100
      - key: MAX_DURATION_MINUTES
        value: 30
    healthCheckPath: /health

  # Celery Worker CPU (Backup - quando GPU worker offline)
  - type: worker
    name: transcription-pro-worker-cpu
    runtime: python
    region: oregon
    plan: free
    buildCommand: pip install -r backend/requirements.txt
    startCommand: cd backend && celery -A app.workers.celery_app worker --loglevel=info --pool=solo -Q cpu-tasks,celery --hostname=render-cpu-worker@%h
    envVars:
      - key: PYTHON_VERSION
        value: 3.12
      - key: DATABASE_URL
        fromDatabase:
          name: transcription-db
          property: connectionString
      - key: REDIS_URL
        fromDatabase:
          name: transcription-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromDatabase:
          name: transcription-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromDatabase:
          name: transcription-redis
          property: connectionString
      - key: DEBUG
        value: false
      - key: WHISPER_MODEL_SIZE
        value: base
      - key: WHISPER_DEVICE
        value: cpu
      - key: WHISPER_COMPUTE_TYPE
        value: int8
      - key: ENABLE_VOCAL_SEPARATION
        value: false

databases:
  # PostgreSQL
  - name: transcription-db
    databaseName: transcriptions
    plan: free
    region: oregon

  # Redis (para Celery)
  - name: transcription-redis
    plan: free
    region: oregon
